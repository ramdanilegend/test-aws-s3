version: "2.1"
orbs:
  aws-s3: circleci/aws-s3@4.0

commands:
  aws_setup:
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli
      - run:
          name: Deploy to AWS
          command: |
            aws configure set region $AWS_DEFAULT_REGION
            aws sts assume-role --role-arn $AWS_IAM_ROLES --role-session-name CircleCIDeploySession > assumed-credentials.json
            export AWS_ACCESS_KEY_ID=$(jq -r '.Credentials.AccessKeyId' assumed-credentials.json)
            export AWS_SECRET_ACCESS_KEY=$(jq -r '.Credentials.SecretAccessKey' assumed-credentials.json)
            export AWS_SESSION_TOKEN=$(jq -r '.Credentials.SessionToken' assumed-credentials.json)
            aws s3 sync dist/ s3://ramdanibucket
  s3_upload:
    parameters:
      # aws_setup_filename:
      #   default: "sdms-cabs.war"
      #   type: string
      # s3_env_folder:
      #   default: "lab"
      #   type: string
    steps:
      - run: ls -l
      # target/<<parameters.aws_setup_filename>>
      # - aws-s3/copy:
      #     from: ~/project/target/<<parameters.aws_setup_filename>>
      #     to: 's3://sdh-ca/cicd-deployment/sdms/admin-portal/<<parameters.s3_env_folder>>/'
jobs:
  Lab-Build-Upload-S3:
    docker:
      - image: cimg/base:2022.05
    steps:
      - aws_setup
      - s3_upload
workflows:
  build-test-and-approval-deploy:
    jobs:
      - Hold-LAB:
          type: approval
          filters:
            branches:
              only: /^setup-circleci.*/
      - Lab-Build-Upload-S3:
          requires:
            - Hold-LAB
